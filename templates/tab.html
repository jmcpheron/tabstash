{% extends "base.html" %}

{% block title %}{{ tab.metadata.title }} - {{ tab.metadata.artist }} | TabStash{% endblock %}

{% block content %}
<article class="tab-page">
    <header class="tab-header">
        <a href="{{ base_url }}/" class="back-link">&larr; All Tabs</a>
        <h1 class="tab-title">{{ tab.metadata.title }}</h1>
        <p class="tab-artist">
            <a href="{{ base_url }}/artist/{{ tab.artist_slug }}.html">{{ tab.metadata.artist }}</a>
        </p>

        <div class="tab-meta">
            {% if tab.metadata.key %}
            <span class="meta-badge">Key: {{ tab.metadata.key }}</span>
            {% endif %}
            {% if tab.metadata.capo > 0 %}
            <span class="meta-badge">Capo: {{ tab.metadata.capo }}</span>
            {% endif %}
            {% if tab.metadata.tuning != "standard" %}
            <span class="meta-badge">{{ tab.metadata.tuning }}</span>
            {% endif %}
            {% if tab.metadata.difficulty %}
            <span class="meta-badge difficulty-{{ tab.metadata.difficulty }}">{{ tab.metadata.difficulty }}</span>
            {% endif %}
            {% if tab.metadata.bpm %}
            <span class="meta-badge">{{ tab.metadata.bpm }} BPM</span>
            {% endif %}
        </div>

        {% if sections %}
        <nav class="section-nav">
            {% for section in sections %}
            <a href="#section-{{ loop.index }}" class="section-pill">{{ section }}</a>
            {% endfor %}
        </nav>
        {% endif %}
    </header>

    <div class="tab-controls">
        <button id="auto-scroll-toggle" class="control-btn">
            <span class="play-icon">&#9654;</span>
            <span class="btn-text">Auto-scroll</span>
        </button>
        <div class="speed-control" id="speed-control" style="display: none;">
            <button class="speed-btn" data-speed="slow">Slow</button>
            <button class="speed-btn active" data-speed="medium">Medium</button>
            <button class="speed-btn" data-speed="fast">Fast</button>
        </div>

        <!-- Metronome controls -->
        <div class="metronome-controls">
            <button id="metronome-toggle" class="control-btn">
                <span class="metronome-icon">&#9835;</span>
                <span class="btn-text">Metronome</span>
            </button>

            <div class="metronome-settings" id="metronome-settings" style="display: none;">
                <div class="bpm-control">
                    <button class="bpm-adjust" id="bpm-down" aria-label="Decrease BPM">-</button>
                    <input type="number" id="bpm-input" class="bpm-input"
                           value="{{ tab.metadata.bpm or 120 }}" min="20" max="300" step="1"
                           aria-label="Beats per minute">
                    <span class="bpm-label">BPM</span>
                    <button class="bpm-adjust" id="bpm-up" aria-label="Increase BPM">+</button>
                </div>
                <button id="sync-toggle" class="sync-btn" title="Sync scroll speed to BPM">
                    <span class="sync-icon">&#128279;</span>
                    <span class="sync-text">Sync</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Beat indicator (visual pulse) -->
    <div class="beat-indicator" id="beat-indicator" aria-hidden="true"></div>

    <div class="tab-content" id="tab-content">
{{ tab.content | replace('[', '<span id="section-' ~ (tab.content[:tab.content.find('[')].count('\n') + 1) ~ '" class="section-header">[') | replace(']', ']</span>') | safe }}
    </div>

    <footer class="tab-footer">
        <a href="{{ base_url }}/" class="back-link">&larr; Back to all tabs</a>
    </footer>
</article>
{% endblock %}

{% block scripts %}
<script src="{{ base_url }}/static/js/auto-scroll.js"></script>
<script src="{{ base_url }}/static/js/metronome.js"></script>
<script>
    // Initialize auto-scroll
    const tabContent = document.getElementById('tab-content');
    const autoScroll = new AutoScroll(tabContent);

    const toggleBtn = document.getElementById('auto-scroll-toggle');
    const speedControl = document.getElementById('speed-control');

    toggleBtn.addEventListener('click', () => {
        autoScroll.toggle();
        toggleBtn.classList.toggle('active', autoScroll.isScrolling);
        speedControl.style.display = autoScroll.isScrolling ? 'flex' : 'none';
    });

    // Speed buttons
    document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            autoScroll.setSpeed(btn.dataset.speed);
        });
    });

    // Tap anywhere on content to toggle (for hands-free practice)
    tabContent.addEventListener('click', (e) => {
        if (e.target.tagName !== 'A') {
            autoScroll.toggle();
            toggleBtn.classList.toggle('active', autoScroll.isScrolling);
            speedControl.style.display = autoScroll.isScrolling ? 'flex' : 'none';
        }
    });

    // ========================================
    // Metronome
    // ========================================

    const beatIndicator = document.getElementById('beat-indicator');

    function onBeat(beatCount, isAccent) {
        beatIndicator.classList.remove('pulse', 'accent');
        // Force reflow to restart animation
        void beatIndicator.offsetWidth;
        beatIndicator.classList.add('pulse');
        if (isAccent) {
            beatIndicator.classList.add('accent');
        }
    }

    const initialBpm = parseInt('{{ tab.metadata.bpm or 120 }}', 10);

    const metronome = new Metronome({
        bpm: initialBpm,
        onBeat: onBeat,
        onBpmChange: (bpm) => {
            document.getElementById('bpm-input').value = bpm;
            autoScroll.updateSyncBpm(bpm);
        }
    });

    // Metronome toggle
    const metronomeToggle = document.getElementById('metronome-toggle');
    const metronomeSettings = document.getElementById('metronome-settings');

    metronomeToggle.addEventListener('click', () => {
        const isRunning = metronome.toggle();
        metronomeToggle.classList.toggle('active', isRunning);
        metronomeSettings.style.display = isRunning ? 'flex' : 'none';
    });

    // BPM controls
    const bpmInput = document.getElementById('bpm-input');
    const bpmDown = document.getElementById('bpm-down');
    const bpmUp = document.getElementById('bpm-up');

    bpmInput.addEventListener('change', () => {
        metronome.setBpm(bpmInput.value);
    });

    bpmDown.addEventListener('click', () => {
        metronome.setBpm(metronome.getBpm() - 5);
    });

    bpmUp.addEventListener('click', () => {
        metronome.setBpm(metronome.getBpm() + 5);
    });

    // Sync toggle
    const syncToggle = document.getElementById('sync-toggle');
    let syncEnabled = false;

    syncToggle.addEventListener('click', () => {
        syncEnabled = !syncEnabled;
        syncToggle.classList.toggle('active', syncEnabled);

        if (syncEnabled) {
            // Calculate pixels per beat based on line height
            const lineHeight = parseFloat(getComputedStyle(tabContent).lineHeight) || 20;
            const linesPerBeat = 0.25; // Advance 1/4 line per beat
            const pixelsPerBeat = lineHeight * linesPerBeat;

            autoScroll.enableSync(pixelsPerBeat, metronome.getBpm());
        } else {
            autoScroll.disableSync();
        }
    });
</script>
{% endblock %}
